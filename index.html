<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Code Mood üé≠ - Version S√©curis√©e</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #3ECF8E 0%, #2B7EC8 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #3ECF8E;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .security-badge {
            display: inline-flex;
            align-items: center;
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .mode-indicator {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: #f8fffc;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3ECF8E;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .form-section, .display-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-section h2 {
            color: #3ECF8E;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3ECF8E;
        }
        
        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background: #fafbfc;
        }
        
        .emoji-btn {
            padding: 12px;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 8px;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-btn:hover {
            transform: scale(1.1);
            border-color: #3ECF8E;
        }
        
        .emoji-btn.selected {
            border-color: #3ECF8E;
            background: #f8fffc;
            transform: scale(1.1);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #3ECF8E 0%, #2B7EC8 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            width: 100%;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .mood-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .mood-item {
            background: #f8fffc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3ECF8E;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .mood-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .student-name {
            font-weight: 600;
            color: #333;
        }
        
        .timestamp {
            font-size: 0.9em;
            color: #666;
        }
        
        .code-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            position: relative;
        }
        
        .language-tag {
            position: absolute;
            top: 5px;
            right: 10px;
            background: #3ECF8E;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .comment {
            color: #a0aec0;
        }
        
        .teacher-controls {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .control-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .control-btn:hover {
            transform: translateY(-1px);
        }
        
        .export-btn {
            background: #38a169;
        }
        
        .refresh-btn {
            background: #3182ce;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .emoji-selector {
                grid-template-columns: repeat(4, 1fr);
                max-height: 250px;
            }
            
            .emoji-btn {
                font-size: 1.5em;
                min-height: 45px;
                padding: 8px;
            }
        }
        
        .mood-visualization {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .mood-bubble {
            display: flex;
            align-items: center;
            background: #f8fffc;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.2em;
            border: 2px solid #e1e8ed;
        }
        
        .mood-count {
            margin-left: 8px;
            background: #3ECF8E;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="security-badge">
                üîê Version S√©curis√©e - Cl√©s API Prot√©g√©es
            </div>
            <h1>üé≠ Emoji Code Mood</h1>
            <p>Exprime ton humeur de rentr√©e avec une ligne de code !</p>
            
            <div class="mode-indicator" id="modeIndicator">
                <span id="modeIcon">‚ö°</span>
                <span id="modeText">Mode Collaboratif - Synchronisation temps r√©el</span>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalParticipants">0</div>
                    <div class="stat-label">Participants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="moodVariety">0</div>
                    <div class="stat-label">Humeurs diff√©rentes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sessionTime">0</div>
                    <div class="stat-label">Minutes</div>
                </div>
            </div>
            
            <div class="mood-visualization" id="moodVisualization"></div>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <h2>üìù Code ton humeur</h2>
                
                <form id="moodForm">
                    <div class="form-group">
                        <label for="studentName">Ton pr√©nom :</label>
                        <input type="text" id="studentName" required placeholder="Ex: Alex" maxlength="30">
                    </div>
                    
                    <div class="form-group">
                        <label>Choisis ton emoji :</label>
                        <div class="emoji-selector">
                            <!-- √ânergie et motivation -->
                            <button type="button" class="emoji-btn" data-emoji="üî•" title="Feu - Motiv√© √† fond">üî•</button>
                            <button type="button" class="emoji-btn" data-emoji="üí™" title="Muscle - Pr√™t au combat">üí™</button>
                            <button type="button" class="emoji-btn" data-emoji="üöÄ" title="Fus√©e - D√©collage imm√©diat">üöÄ</button>
                            <button type="button" class="emoji-btn" data-emoji="‚ö°" title="√âclair - √ânergie √©lectrique">‚ö°</button>
                            <button type="button" class="emoji-btn" data-emoji="üåü" title="√âtoile - Brillant aujourd'hui">üåü</button>
                            <button type="button" class="emoji-btn" data-emoji="‚ú®" title="√âtincelles - Magique">‚ú®</button>
                            
                            <!-- Fatigue et repos -->
                            <button type="button" class="emoji-btn" data-emoji="üò¥" title="Endormi - Mode sieste">üò¥</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•±" title="B√¢illement - Fatigue">ü•±</button>
                            <button type="button" class="emoji-btn" data-emoji="‚òï" title="Caf√© - Besoin de caf√©ine">‚òï</button>
                            <button type="button" class="emoji-btn" data-emoji="üõå" title="Lit - Envie de dormir">üõå</button>
                            <button type="button" class="emoji-btn" data-emoji="üí§" title="ZZZ - Assoupi">üí§</button>
                            <button type="button" class="emoji-btn" data-emoji="üßü" title="Zombie - Mode survie">üßü</button>
                            
                            <!-- Stress et d√©fi -->
                            <button type="button" class="emoji-btn" data-emoji="ü§Ø" title="Explosion - Cerveau overload">ü§Ø</button>
                            <button type="button" class="emoji-btn" data-emoji="üò∞" title="Sueur - Stress intensif">üò∞</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•µ" title="Chaud - Pression maximum">ü•µ</button>
                            <button type="button" class="emoji-btn" data-emoji="üòì" title="Goutte sueur - Inquiet">üòì</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§™" title="Fou - Compl√®tement perch√©">ü§™</button>
                            <button type="button" class="emoji-btn" data-emoji="üôÉ" title="√Ä l'envers - Monde invers√©">üôÉ</button>
                            
                            <!-- Confiance et cool -->
                            <button type="button" class="emoji-btn" data-emoji="üòé" title="Cool - Ma√Ætre de l'univers">üòé</button>
                            <button type="button" class="emoji-btn" data-emoji="üòè" title="Smirk - Je sais tout">üòè</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§ì" title="Geek - Mode intellectuel">ü§ì</button>
                            <button type="button" class="emoji-btn" data-emoji="üòå" title="Zen - Parfaitement serein">üòå</button>
                            <button type="button" class="emoji-btn" data-emoji="üòä" title="Sourire - Bonne humeur">üòä</button>
                            <button type="button" class="emoji-btn" data-emoji="üòÅ" title="Grand sourire - Joie">üòÅ</button>
                            
                            <!-- R√©flexion et questionnement -->
                            <button type="button" class="emoji-btn" data-emoji="ü§î" title="R√©flexion - En train de cogiter">ü§î</button>
                            <button type="button" class="emoji-btn" data-emoji="üßê" title="Monocle - Analyse pouss√©e">üßê</button>
                            <button type="button" class="emoji-btn" data-emoji="üëÄ" title="Yeux - J'observe tout">üëÄ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§®" title="Sourcil lev√© - Sceptique">ü§®</button>
                            <button type="button" class="emoji-btn" data-emoji="üò¨" title="Grimace - Pas tr√®s s√ªr">üò¨</button>
                            <button type="button" class="emoji-btn" data-emoji="üòï" title="D√©√ßu - Un peu triste">üòï</button>
                            
                            <!-- Humour et l√©g√®ret√© -->
                            <button type="button" class="emoji-btn" data-emoji="üòÖ" title="Rire nerveux - √áa va aller">üòÖ</button>
                            <button type="button" class="emoji-btn" data-emoji="üòÇ" title="Larmes de joie - Mort de rire">üòÇ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§£" title="Rire aux √©clats - Explosion">ü§£</button>
                            <button type="button" class="emoji-btn" data-emoji="üòÑ" title="Sourire √©clatant - Super content">üòÑ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•≥" title="F√™te - Mode c√©l√©bration">ü•≥</button>
                            <button type="button" class="emoji-btn" data-emoji="üéâ" title="Confettis - Party time">üéâ</button>
                            
                            <!-- Tech et geek -->
                            <button type="button" class="emoji-btn" data-emoji="üíª" title="Laptop - Mode d√©veloppeur">üíª</button>
                            <button type="button" class="emoji-btn" data-emoji="üñ•Ô∏è" title="Desktop - Workstation ready">üñ•Ô∏è</button>
                            <button type="button" class="emoji-btn" data-emoji="‚å®Ô∏è" title="Clavier - Ready to code">‚å®Ô∏è</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§ñ" title="Robot - IA activated">ü§ñ</button>
                            <button type="button" class="emoji-btn" data-emoji="üëæ" title="Alien - Mode gaming">üëæ</button>
                            <button type="button" class="emoji-btn" data-emoji="üéØ" title="Cible - Objectif lock">üéØ</button>
                            
                            <!-- Sp√©ciaux -->
                            <button type="button" class="emoji-btn" data-emoji="ü¶Ñ" title="Licorne - Mood magique">ü¶Ñ</button>
                            <button type="button" class="emoji-btn" data-emoji="üé≠" title="Masques - Humeur th√©√¢trale">üé≠</button>
                            <button type="button" class="emoji-btn" data-emoji="üé≤" title="D√© - Mood al√©atoire">üé≤</button>
                            <button type="button" class="emoji-btn" data-emoji="üåà" title="Arc-en-ciel - Toutes les couleurs">üåà</button>
                            <button type="button" class="emoji-btn" data-emoji="üçï" title="Pizza - Mood gourmand">üçï</button>
                            <button type="button" class="emoji-btn" data-emoji="üé∏" title="Guitare - Rock'n'code">üé∏</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="language">Langage de programmation :</label>
                        <select id="language" required>
                            <option value="">Choisis un langage</option>
                            <option value="javascript">JavaScript</option>
                            <option value="typescript">TypeScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="php">PHP</option>
                            <option value="cpp">C++</option>
                            <option value="rust">Rust</option>
                            <option value="go">Go</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="comment">Commentaire (optionnel) :</label>
                        <input type="text" id="comment" placeholder="Clique pour des id√©es..." list="commentSuggestions" maxlength="100">
                        <datalist id="commentSuggestions">
                            <option value="pr√™t pour attaquer les projets">
                            <option value="besoin d'un deuxi√®me caf√©">
                            <option value="cerveau en surchauffe">
                            <option value="easy peasy lemon squeezy">
                            <option value="mode r√©flexion intense">
                            <option value="je fais semblant de comprendre">
                            <option value="404 motivation not found">
                            <option value="mood de licorne cosmique">
                            <option value="while(motivation) { code(); }">
                            <option value="git commit -m 'nouvelle ann√©e'">
                            <option value="printf('hello world');">
                            <option value="sudo apt install motivation">
                            <option value="import happiness from 'vacation'">
                            <option value="let mood = 'awesome'">
                            <option value="humeur = 'super'">
                        </datalist>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submitBtn">Envoyer mon code mood ! üöÄ</button>
                </form>
            </div>
            
            <div class="display-section">
                <h2>üíª Mood Board de la classe</h2>
                <div class="mood-list" id="moodList">
                    <div class="loading">
                        <p>ü§ñ En attente des premiers codes mood...</p>
                        <p style="font-size: 0.9em; margin-top: 10px; color: #666;">
                            Mode collaboratif activ√© - Synchronisation temps r√©el
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="teacher-controls">
            <h3 style="margin-bottom: 15px; color: #3ECF8E;">üéì Contr√¥les enseignant</h3>
            <button class="control-btn refresh-btn" onclick="loadMoods()">üîÑ Actualiser</button>
            <button class="control-btn" onclick="clearAllMoods()">üóëÔ∏è Effacer tout</button>
            <button class="control-btn export-btn" onclick="exportMoods()">üìÑ Exporter CSV</button>
            <button class="control-btn export-btn" onclick="exportMoodsJSON()">üíæ Export JSON</button>
        </div>
    </div>

    <!-- Configuration priv√©e inject√©e automatiquement par GitHub Actions -->
    <!-- PRIVATE_CONFIG_PLACEHOLDER -->

    <script type="module">
        // ========================================
        // CONFIGURATION ET INITIALISATION
        // ========================================
        
        console.log('üé≠ Emoji Code Mood - Version S√©curis√©e v2.0');
        
        // Configuration par d√©faut (mode local)
        let CONFIG = {
            mode: 'local',
            supabaseUrl: null,
            supabaseAnonKey: null,
            useRealtime: false
        };
        
        // D√©tection automatique de la configuration priv√©e
        if (typeof window.PRIVATE_CONFIG !== 'undefined') {
            CONFIG = { ...CONFIG, ...window.PRIVATE_CONFIG };
            console.log('‚úÖ Configuration priv√©e d√©tect√©e - Mode Supabase activ√©');
        } else {
            console.log('üì¶ Mode local activ√© - Donn√©es stock√©es dans le navigateur');
        }
        
        // Variables globales
        let supabase = null;
        let moods = [];
        let selectedEmoji = '';
        let sessionStartTime = new Date();
        
        // ========================================
        // INITIALISATION SUPABASE
        // ========================================
        
        async function initSupabase() {
            try {
                if (CONFIG.mode === 'supabase' && CONFIG.supabaseUrl && CONFIG.supabaseAnonKey) {
                    const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                    
                    supabase = createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
                    
                    // Test de connexion
                    const { data, error } = await supabase.from('moods').select('count').limit(1);
                    if (error) {
                        console.warn('‚ö†Ô∏è Erreur Supabase, basculement en mode local:', error.message);
                        CONFIG.mode = 'local';
                        return false;
                    }
                    
                    console.log('üöÄ Supabase connect√© avec succ√®s');
                    await loadMoodsFromSupabase();
                    setupRealtimeSubscription();
                    return true;
                }
                return false;
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur d\'initialisation Supabase:', error);
                CONFIG.mode = 'local';
                return false;
            }
        }
        
        async function loadMoodsFromSupabase() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('moods')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                moods = data || [];
                updateDisplay();
                console.log(`üìä ${moods.length} mood codes charg√©s depuis Supabase`);
            } catch (error) {
                console.error('‚ùå Erreur chargement Supabase:', error);
            }
        }
        
        function setupRealtimeSubscription() {
            if (!supabase) return;
            
            supabase
                .channel('moods_realtime')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'moods' },
                    (payload) => {
                        console.log('üîÑ Changement temps r√©el:', payload.eventType);
                        
                        if (payload.eventType === 'INSERT') {
                            moods.unshift(payload.new);
                            updateDisplay();
                            
                            // Animation d'arriv√©e
                            setTimeout(() => {
                                const newItem = document.querySelector('.mood-item');
                                if (newItem) newItem.style.animation = 'slideIn 0.5s ease';
                            }, 100);
                        } else if (payload.eventType === 'DELETE') {
                            loadMoodsFromSupabase();
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('üì° Realtime status:', status);
                });
        }
        
        // ========================================
        // MODE LOCAL
        // ========================================
        
        function initLocalMode() {
            console.log('üíæ Mode local initialis√©');
            moods = JSON.parse(localStorage.getItem('emoji-mood-local') || '[]');
            updateDisplay();
            
            // Mise √† jour de l'interface
            const modeIndicator = document.getElementById('modeIndicator');
            const modeIcon = document.getElementById('modeIcon');
            const modeText = document.getElementById('modeText');
            
            modeIndicator.style.background = '#fff3e0';
            modeIndicator.style.color = '#f57c00';
            modeIndicator.style.borderColor = '#ffcc02';
            modeIcon.textContent = 'üíæ';
            modeText.textContent = 'Mode Local - Donn√©es stock√©es dans ce navigateur';
        }
        
        function saveLocalMoods() {
            localStorage.setItem('emoji-mood-local', JSON.stringify(moods));
        }
        
        // ========================================
        // GESTION DES MOOD CODES
        // ========================================
        
        async function addMood(mood) {
            mood.created_at = new Date().toISOString();
            
            if (CONFIG.mode === 'supabase' && supabase) {
                try {
                    const { data, error } = await supabase
                        .from('moods')
                        .insert([mood])
                        .select();
                    
                    if (error) throw error;
                    console.log('‚úÖ Mood ajout√© √† Supabase');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erreur ajout Supabase:', error);
                    // Fallback local
                    mood.id = Date.now();
                    moods.unshift(mood);
                    saveLocalMoods();
                    updateDisplay();
                    return true;
                }
            } else {
                // Mode local
                mood.id = Date.now();
                moods.unshift(mood);
                saveLocalMoods();
                updateDisplay();
                return true;
            }
        }
        
        // ========================================
        // INTERFACE UTILISATEUR
        // ========================================
        
        function setupEventListeners() {
            // Gestion de la s√©lection d'emoji
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedEmoji = btn.dataset.emoji;
                });
            });
            
            // Gestion du formulaire
            document.getElementById('moodForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitMood();
            });
            
            // Timer de session
            setInterval(() => {
                const minutes = Math.floor((new Date() - sessionStartTime) / 60000);
                document.getElementById('sessionTime').textContent = minutes;
            }, 60000);
        }

        async function submitMood() {
            const name = document.getElementById('studentName').value.trim();
            const language = document.getElementById('language').value;
            const comment = document.getElementById('comment').value;

            // Validation
            if (!name) {
                alert('Merci de renseigner ton pr√©nom !');
                return;
            }

            if (!selectedEmoji) {
                alert('Merci de choisir un emoji !');
                return;
            }

            if (!language || language === 'Choisis un langage') {
                alert('Merci de choisir un langage de programmation !');
                return;
            }

            // Cr√©er l'objet mood
            const mood = {
                name: name,
                emoji: selectedEmoji,
                language: language,
                comment: comment || '',
                timestamp: new Date().toISOString()
            };

            // Ajouter le mood
            const success = await addMood(mood);
            
            if (success) {
                // R√©initialiser le formulaire
                document.getElementById('moodForm').reset();
                selectedEmoji = null;
                document.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('selected'));
                
                // Message de succ√®s
                console.log('‚úÖ Mood code envoy√© avec succ√®s!');
            }
        }

        function updateDisplay() {
            const moodDisplay = document.getElementById('moodList');
            const participantsCount = document.getElementById('totalParticipants');
            const uniqueMoodsCount = document.getElementById('moodVariety');
            
            if (!moodDisplay) return;

            // Mise √† jour des statistiques
            participantsCount.textContent = moods.length;
            const uniqueEmojis = new Set(moods.map(m => m.emoji));
            uniqueMoodsCount.textContent = uniqueEmojis.size;

            if (moods.length === 0) {
                moodDisplay.innerHTML = `
                    <div class="no-moods">
                        <p>ü§ñ En attente des premiers codes mood...</p>
                        <p>Mode collaboratif activ√© - Synchronisation temps r√©el</p>
                    </div>
                `;
                return;
            }

            // Afficher les mood codes
            moodDisplay.innerHTML = moods.map(mood => `
                <div class="mood-item">
                    <div class="mood-header">
                        <span class="student-name">${mood.name}</span>
                        <span class="timestamp">${formatTimestamp(mood.created_at || mood.timestamp)}</span>
                    </div>
                    <div class="code-display">
                        <div class="language-tag">${mood.language}</div>
                        <pre><code>// ${mood.comment || 'Code mood'} ${mood.emoji}
const mood = "${mood.emoji}";
console.log("Humeur du jour:", mood);

// ${mood.name} - ${mood.language}</code></pre>
                    </div>
                </div>
            `).join('');
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return "√Ä l'instant";
            if (diffMins < 60) return `Il y a ${diffMins} min`;
            if (diffMins < 1440) return `Il y a ${Math.floor(diffMins / 60)}h`;
            return date.toLocaleDateString('fr-FR');
        }

        // ========================================
        // CONTR√îLES ENSEIGNANT
        // ========================================

        async function loadMoods() {
            if (CONFIG.mode === 'supabase' && supabase) {
                await loadMoodsFromSupabase();
            } else {
                moods = JSON.parse(localStorage.getItem('emoji-mood-local') || '[]');
                updateDisplay();
            }
            console.log('üîÑ Moods recharg√©s');
        }

        async function clearAllMoods() {
            if (!confirm('√ätes-vous s√ªr de vouloir effacer tous les mood codes ?')) {
                return;
            }

            if (CONFIG.mode === 'supabase' && supabase) {
                try {
                    const { error } = await supabase.from('moods').delete().neq('id', 0);
                    if (error) throw error;
                    console.log('üóëÔ∏è Tous les moods supprim√©s de Supabase');
                } catch (error) {
                    console.error('‚ùå Erreur suppression Supabase:', error);
                }
            } else {
                localStorage.removeItem('emoji-mood-local');
                console.log('üóëÔ∏è Tous les moods supprim√©s du stockage local');
            }
            
            moods = [];
            updateDisplay();
        }

        function exportMoods() {
            if (moods.length === 0) {
                alert('Aucun mood code √† exporter !');
                return;
            }

            // Cr√©er le CSV
            const headers = ['Nom', 'Emoji', 'Langage', 'Commentaire', 'Timestamp'];
            const csvContent = [
                headers.join(','),
                ...moods.map(mood => [
                    `"${mood.name}"`,
                    `"${mood.emoji}"`,
                    `"${mood.language}"`,
                    `"${mood.comment || ''}"`,
                    `"${mood.created_at || mood.timestamp}"`
                ].join(','))
            ].join('\n');

            // T√©l√©charger
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `mood-codes-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportMoodsJSON() {
            if (moods.length === 0) {
                alert('Aucun mood code √† exporter !');
                return;
            }

            const jsonContent = JSON.stringify(moods, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `mood-codes-${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ========================================
        // INITIALISATION
        // ========================================

        async function init() {
            console.log('üöÄ Initialisation de l\'application...');
            
            sessionStartTime = new Date();
            
            // Tentative de connexion Supabase
            const supabaseConnected = await initSupabase();
            
            if (!supabaseConnected) {
                // Mode local
                initLocalMode();
            }
            
            // Configuration des √©couteurs d'√©v√©nements
            setupEventListeners();
            
            // Chargement initial des donn√©es
            await loadMoods();
            
            console.log('‚úÖ Application initialis√©e avec succ√®s');
        }

        // ========================================
        // FONCTIONS GLOBALES POUR LES CONTR√îLES
        // ========================================
        
        // Exposer les fonctions globalement pour les onclick handlers
        window.loadMoods = loadMoods;
        window.clearAllMoods = clearAllMoods;
        window.exportMoods = exportMoods;
        window.exportMoodsJSON = exportMoodsJSON;

        // D√©marrer l'application quand le DOM est pr√™t
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
